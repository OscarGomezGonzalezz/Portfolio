<script setup>

import {gsap} from "gsap";
import {ScrollTrigger} from "gsap/ScrollTrigger";
import {Draggable} from "gsap/Draggable";
import {InertiaPlugin} from "gsap/InertiaPlugin";
import {Observer} from "gsap/Observer";

gsap.registerPlugin(ScrollTrigger, Draggable, InertiaPlugin, Observer);

const portfolioData = [
{
    "id": "77790b2b-f14a-4b62-ac1c-75faa334578f",
    "title": "Before Tech",
    "listed": true,
    "slug": "advancing-healthcare",
    "type": "Interactive Visualization",
    "videoWebm": "",
    "videoMP4": "",
    "cover": "/captures/beginning.jpg",
    "client": "Deerfield",
    "clientLogo": null,
    "partner": "White Rhino",
    "completed": 2019,
    "stack": [
      {
        "id": "b0f3b137-8162-42b9-9374-929833891c93",
        "name": "GSAP",
        "color": "pink"
      },
      {
        "id": "945e2733-0557-49d6-91ca-b5924dc95216",
        "name": "HTML5 Canvas",
        "color": "brown"
      },
      {
        "id": "b8723929-bf87-4ce5-9062-5f3bd20e06b4",
        "name": "SCSS",
        "color": "default"
      }
    ],
    "role": "Creative Developer",
    "lead": "Building a dynamic coundreds of creatively animated, interactive dots.",
    "awards": null,
    "pageContent": [
      {
        "object": "block",
        "id": "8ecc0cad-7ca4-4a56-922a-7b5cfc022d85",
        "parent": {
          "type": "page_id",
          "page_id": "77790b2b-f14a-4b62-ac1c-75faa334578f"
        },
        "created_time": "2023-01-10T03:45:00.000Z",
        "last_edited_time": "2023-02-10T20:33:00.000Z",
        "created_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "last_edited_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "has_children": false,
        "archived": false,
        "in_trash": false,
        "type": "paragraph",
        "paragraph": {
          "rich_text": [
            {
              "type": "text",
              "text": {
                "content": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to br. The challenge that presented itself was how visitors would find content, and how to display it to prouser experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
                "link": null
              },
              "annotations": {
                "bold": false,
                "italic": false,
                "strikethrough": false,
                "underline": false,
                "code": false,
                "color": "default"
              },
              "plain_text": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to browse and denge that presented itself was how visitors would find content, and how to display it to proThe user experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
              "href": null
            }
          ],
          "color": "default"
        }
      },
    ]
  },
  {
    "id": "77790b2b-f14a-4b62-ac1c-75faa334578f",
    "title": "Advancing Healthcare",
    "listed": true,
    "slug": "advancing-healthcare",
    "type": "Interactive Visualization",
    "videoWebm": "",
    "videoMP4": "videos/sevilla.mp4",
    "cover": "",
    "client": "Deerfield",
    "clientLogo": null,
    "partner": "White Rhino",
    "completed": 2019,
    "stack": [
      {
        "id": "b0f3b137-8162-42b9-9374-929833891c93",
        "name": "GSAP",
        "color": "pink"
      },
      {
        "id": "945e2733-0557-49d6-91ca-b5924dc95216",
        "name": "HTML5 Canvas",
        "color": "brown"
      },
      {
        "id": "b8723929-bf87-4ce5-9062-5f3bd20e06b4",
        "name": "SCSS",
        "color": "default"
      }
    ],
    "role": "Creative Developer",
    "lead": "Building a dynamic contene with hundreds of creatively animated, interactive dots.",
    "awards": null,
    "pageContent": [
      {
        "object": "block",
        "id": "8ecc0cad-7ca4-4a56-922a-7b5cfc022d85",
        "parent": {
          "type": "page_id",
          "page_id": "77790b2b-f14a-4b62-ac1c-75faa334578f"
        },
        "created_time": "2023-01-10T03:45:00.000Z",
        "last_edited_time": "2023-02-10T20:33:00.000Z",
        "created_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "last_edited_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "has_children": false,
        "archived": false,
        "in_trash": false,
        "type": "paragraph",
        "paragraph": {
          "rich_text": [
            {
              "type": "text",
              "text": {
                "content": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to browsllenge that presented itself was how visitors would find content, and how to display it to promote ery. The user experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
                "link": null
              },
              "annotations": {
                "bold": false,
                "italic": false,
                "strikethrough": false,
                "underline": false,
                "code": false,
                "color": "default"
              },
              "plain_text": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to browallenge that presented itself was how visitors would find content, and how to display it to pry. The user experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
              "href": null
            }
          ],
          "color": "default"
        }
      },
    ]
  },
  {
    "id": "77790b2b-f14a-4b62-ac1c-75faa334578f",
    "title": "Advancing Healthcare",
    "listed": true,
    "slug": "advancing-healthcare",
    "type": "Interactive Visualization",
    "videoWebm": "",
    "videoMP4": "",
    "cover": "captures/germany.PNG",
    "client": "Deerfield",
    "clientLogo": null,
    "partner": "White Rhino",
    "completed": 2019,
    "stack": [
      {
        "id": "b0f3b137-8162-42b9-9374-929833891c93",
        "name": "GSAP",
        "color": "pink"
      },
      {
        "id": "945e2733-0557-49d6-91ca-b5924dc95216",
        "name": "HTML5 Canvas",
        "color": "brown"
      },
      {
        "id": "b8723929-bf87-4ce5-9062-5f3bd20e06b4",
        "name": "SCSS",
        "color": "default"
      }
    ],
    "role": "Creative Developer",
    "lead": "Building a dynamic contentovery experience with hundreds of creatively animated, interactive dots.",
    "awards": null,
    "pageContent": [
      {
        "object": "block",
        "id": "8ecc0cad-7ca4-4a56-922a-7b5cfc022d85",
        "parent": {
          "type": "page_id",
          "page_id": "77790b2b-f14a-4b62-ac1c-75faa334578f"
        },
        "created_time": "2023-01-10T03:45:00.000Z",
        "last_edited_time": "2023-02-10T20:33:00.000Z",
        "created_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "last_edited_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "has_children": false,
        "archived": false,
        "in_trash": false,
        "type": "paragraph",
        "paragraph": {
          "rich_text": [
            {
              "type": "text",
              "text": {
                "content": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to brow. The challenge that presented itself was how visitors would find content, and how to display it to promote discovery. The user experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
                "link": null
              },
              "annotations": {
                "bold": false,
                "italic": false,
                "strikethrough": false,
                "underline": false,
                "code": false,
                "color": "default"
              },
              "plain_text": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to browse presented itself was how visitors would find content, and how to display it to pro The user experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
              "href": null
            }
          ],
          "color": "default"
        }
      },
    ]
  },
  {
    "id": "77790b2b-f14a-4b62-ac1c-75faa334578f",
    "title": "Advancing Healthcare",
    "listed": true,
    "slug": "advancing-healthcare",
    "type": "Interactive Visualization",
    "videoWebm": "",
    "videoMP4": "",
    "cover": "captures/research.webp",
    "client": "Deerfield",
    "clientLogo": null,
    "partner": "White Rhino",
    "completed": 2019,
    "stack": [
      {
        "id": "b0f3b137-8162-42b9-9374-929833891c93",
        "name": "GSAP",
        "color": "pink"
      },
      {
        "id": "945e2733-0557-49d6-91ca-b5924dc95216",
        "name": "HTML5 Canvas",
        "color": "brown"
      },
      {
        "id": "b8723929-bf87-4ce5-9062-5f3bd20e06b4",
        "name": "SCSS",
        "color": "default"
      }
    ],
    "role": "Creative Developer",
    "lead": "Building a dynamic contentovery experience with hundreds of creatively animated, interactive dots.",
    "awards": null,
    "pageContent": [
      {
        "object": "block",
        "id": "8ecc0cad-7ca4-4a56-922a-7b5cfc022d85",
        "parent": {
          "type": "page_id",
          "page_id": "77790b2b-f14a-4b62-ac1c-75faa334578f"
        },
        "created_time": "2023-01-10T03:45:00.000Z",
        "last_edited_time": "2023-02-10T20:33:00.000Z",
        "created_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "last_edited_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "has_children": false,
        "archived": false,
        "in_trash": false,
        "type": "paragraph",
        "paragraph": {
          "rich_text": [
            {
              "type": "text",
              "text": {
                "content": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to brow. The challenge that presented itself was how visitors would find content, and how to display it to promote discovery. The user experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
                "link": null
              },
              "annotations": {
                "bold": false,
                "italic": false,
                "strikethrough": false,
                "underline": false,
                "code": false,
                "color": "default"
              },
              "plain_text": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to browse presented itself was how visitors would find content, and how to display it to pro The user experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
              "href": null
            }
          ],
          "color": "default"
        }
      },
    ]
  },
  {
    "id": "77790b2b-f14a-4b62-ac1c-75faa334578f",
    "title": "Advancing Healthcare",
    "listed": true,
    "slug": "advancing-healthcare",
    "type": "Interactive Visualization",
    "videoWebm": "",
    "videoMP4": "videos/esb.mp4",
    "cover": "captures/research.webp",
    "client": "Deerfield",
    "clientLogo": null,
    "partner": "White Rhino",
    "completed": 2019,
    "stack": [
      {
        "id": "b0f3b137-8162-42b9-9374-929833891c93",
        "name": "GSAP",
        "color": "pink"
      },
      {
        "id": "945e2733-0557-49d6-91ca-b5924dc95216",
        "name": "HTML5 Canvas",
        "color": "brown"
      },
      {
        "id": "b8723929-bf87-4ce5-9062-5f3bd20e06b4",
        "name": "SCSS",
        "color": "default"
      }
    ],
    "role": "Creative Developer",
    "lead": "Building a dynamic contentovery experience with hundreds of creatively animated, interactive dots.",
    "awards": null,
    "pageContent": [
      {
        "object": "block",
        "id": "8ecc0cad-7ca4-4a56-922a-7b5cfc022d85",
        "parent": {
          "type": "page_id",
          "page_id": "77790b2b-f14a-4b62-ac1c-75faa334578f"
        },
        "created_time": "2023-01-10T03:45:00.000Z",
        "last_edited_time": "2023-02-10T20:33:00.000Z",
        "created_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "last_edited_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "has_children": false,
        "archived": false,
        "in_trash": false,
        "type": "paragraph",
        "paragraph": {
          "rich_text": [
            {
              "type": "text",
              "text": {
                "content": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to brow. The challenge that presented itself was how visitors would find content, and how to display it to promote discovery. The user experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
                "link": null
              },
              "annotations": {
                "bold": false,
                "italic": false,
                "strikethrough": false,
                "underline": false,
                "code": false,
                "color": "default"
              },
              "plain_text": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to browse presented itself was how visitors would find content, and how to display it to pro The user experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
              "href": null
            }
          ],
          "color": "default"
        }
      },
    ]
  },
  {
    "id": "77790b2b-f14a-4b62-ac1c-75faa334578f",
    "title": "Advancing Healthcare",
    "listed": true,
    "slug": "advancing-healthcare",
    "type": "Interactive Visualization",
    "videoWebm": "videos/reutlingen_video.mp4",
    "videoMP4": "",
    "cover": "captures/reutlingen.jpg",
    "client": "Deerfield",
    "clientLogo": null,
    "partner": "White Rhino",
    "completed": 2019,
    "stack": [
      {
        "id": "b0f3b137-8162-42b9-9374-929833891c93",
        "name": "GSAP",
        "color": "pink"
      },
      {
        "id": "945e2733-0557-49d6-91ca-b5924dc95216",
        "name": "HTML5 Canvas",
        "color": "brown"
      },
      {
        "id": "b8723929-bf87-4ce5-9062-5f3bd20e06b4",
        "name": "SCSS",
        "color": "default"
      }
    ],
    "role": "Creative Developer",
    "lead": "Building a dynamic contentovery experience with hundreds of creatively animated, interactive dots.",
    "awards": null,
    "pageContent": [
      {
        "object": "block",
        "id": "8ecc0cad-7ca4-4a56-922a-7b5cfc022d85",
        "parent": {
          "type": "page_id",
          "page_id": "77790b2b-f14a-4b62-ac1c-75faa334578f"
        },
        "created_time": "2023-01-10T03:45:00.000Z",
        "last_edited_time": "2023-02-10T20:33:00.000Z",
        "created_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "last_edited_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "has_children": false,
        "archived": false,
        "in_trash": false,
        "type": "paragraph",
        "paragraph": {
          "rich_text": [
            {
              "type": "text",
              "text": {
                "content": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to brow. The challenge that presented itself was how visitors would find content, and how to display it to promote discovery. The user experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
                "link": null
              },
              "annotations": {
                "bold": false,
                "italic": false,
                "strikethrough": false,
                "underline": false,
                "code": false,
                "color": "default"
              },
              "plain_text": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to browse presented itself was how visitors would find content, and how to display it to pro The user experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
              "href": null
            }
          ],
          "color": "default"
        }
      },
    ]
  },
  {
    "id": "77790b2b-f14a-4b62-ac1c-75faa334578f",
    "title": "Advancing Healthcare",
    "listed": true,
    "slug": "advancing-healthcare",
    "type": "Interactive Visualization",
    "videoWebm": "",
    "videoMP4": "",
    "cover": "captures/now.png",
    "client": "Deerfield",
    "clientLogo": null,
    "partner": "White Rhino",
    "completed": 2019,
    "stack": [
      {
        "id": "b0f3b137-8162-42b9-9374-929833891c93",
        "name": "GSAP",
        "color": "pink"
      },
      {
        "id": "945e2733-0557-49d6-91ca-b5924dc95216",
        "name": "HTML5 Canvas",
        "color": "brown"
      },
      {
        "id": "b8723929-bf87-4ce5-9062-5f3bd20e06b4",
        "name": "SCSS",
        "color": "default"
      }
    ],
    "role": "Creative Developer",
    "lead": "Building a dynamic contentovery experience with hundreds of creatively animated, interactive dots.",
    "awards": null,
    "pageContent": [
      {
        "object": "block",
        "id": "8ecc0cad-7ca4-4a56-922a-7b5cfc022d85",
        "parent": {
          "type": "page_id",
          "page_id": "77790b2b-f14a-4b62-ac1c-75faa334578f"
        },
        "created_time": "2023-01-10T03:45:00.000Z",
        "last_edited_time": "2023-02-10T20:33:00.000Z",
        "created_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "last_edited_by": {
          "object": "user",
          "id": "850b2956-a12b-4dd0-a6bd-d72a0f8cd68f"
        },
        "has_children": false,
        "archived": false,
        "in_trash": false,
        "type": "paragraph",
        "paragraph": {
          "rich_text": [
            {
              "type": "text",
              "text": {
                "content": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to brow. The challenge that presented itself was how visitors would find content, and how to display it to promote discovery. The user experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
                "link": null
              },
              "annotations": {
                "bold": false,
                "italic": false,
                "strikethrough": false,
                "underline": false,
                "code": false,
                "color": "default"
              },
              "plain_text": "Deerfield is an investment management company with a focus on healthcare - with hundreds of articles on their website for visitors to browse presented itself was how visitors would find content, and how to display it to pro The user experience had to guide users towards key content, while also keeping it well organized and fluid enough that you could explore in many different ways.",
              "href": null
            }
          ],
          "color": "default"
        }
      },
    ]
  }
  ]

// TODO: Review on mobile and perhaps make the cards a little smaller - need to handle resize event.

/**
 * The proxy element that Draggable will use to track the drag action
 */
let proxy = null;

/**
 * The animation to be controlled by Draggable
 */
let animation = null;

/**
 * The Observer instance that will be used to track mouse wheel events
 */
let wheelObserver = null;

/**
 * Flag to indicate whether the user is interacting with the slider
 */
let isInteracting = false;

/**
 * The ID of the animation frame that will be used to update the position of the slider
 */
let animationFrameId;

onMounted(async () => {

  // Let's calculate some starting values
  const cardsContainer = document.querySelector('.cards');
  const cards = gsap.utils.toArray('.card');
  let wrapWidth = document.querySelector('.cards').offsetWidth;
  wrapWidth = cards.reduce((acc, card) => acc + card.offsetWidth, 0);
  let widestCardWidth = Math.max(...cards.map(card => card.offsetWidth));
  let position = 0;

  // Set the initial position of each card in the slider
  cards.forEach((card, i) => {
    gsap.set(card, {x: position, left: -widestCardWidth});
    position += card.offsetWidth + 5; // Add 5px for spacing between cards
    wrapWidth += 5; // Add 5px for spacing between cards
  });

  // Creating a draggable proxy element
  proxy = document.createElement("div");

const startIndex = 0;
let initialX = 0;
for (let i = 0; i < startIndex; i++) {
  initialX -= cards[i].offsetWidth + 5;
}
gsap.set(proxy, { x: initialX });



  // GSAP animation controlled by Draggable
  animation = gsap.to(cards, {
    x: "+=" + wrapWidth,
    ease: "none",
    paused: true,
    repeat: -1,
    modifiers: {
      x: gsap.utils.unitize(x => parseFloat(x) % wrapWidth),
    }
  });

  // Initialize Draggable
  Draggable.create(proxy, {
    type: "x",
    trigger: cardsContainer,
    inertia: true,
    onPress: () => {
      isInteracting = true;
      cancelAnimationFrame(animationFrameId);
    },
    onRelease: () => {
      isInteracting = false;
      animationFrameId = requestAnimationFrame(updatePosition);
    },
    onThrowComplete: updateAnimation,
    onDrag: updateAnimation,
    onThrowUpdate: updateAnimation,
  });

  // Utility function to wrap items around the slider infinitely
  const wrapProgress = gsap.utils.wrap(0, 1)
  const props = gsap.getProperty(proxy);

  // Function to update GSAP animation progress based on drag action
  function updateAnimation() {
    animation.progress(wrapProgress((props("x") + widestCardWidth) / wrapWidth));
  }

  // Now let's also make it work with mouse wheel
  wheelObserver = Observer.create({
    type: "wheel",
    onWheel: (self) => {
      gsap.to(proxy, {
        x: "+=" + (self.deltaY < 0 ? 1200 : -1200),
        onUpdate: () => updateAnimation(),
        ease: "power1.out",
        duration: 0.5
      });
    },
    onWheelStart: () => {
      isInteracting = true;
      cancelAnimationFrame(animationFrameId);
    },
    onWheelEnd: () => {
      isInteracting = false;
      animationFrameId = requestAnimationFrame(updatePosition);
    },
    preventDefault: true,
  });

  // Lastly, let's get an ambient scrolling motion going on when the user is not interacting with the slider
  const updatePosition = () => {
    if (!isInteracting) { // Only update position if user is not interacting
      const currentX = parseFloat(gsap.getProperty(proxy, "x")) || 0;
      const newX = currentX - (40 / 60);

      gsap.set(proxy, {x: newX % wrapWidth});
      updateAnimation();
    }
    animationFrameId = requestAnimationFrame(updatePosition);
  };
  animationFrameId = requestAnimationFrame(updatePosition);

});

// Commit mass murder
onUnmounted(() => {
  wheelObserver.kill();
  animation.kill();
  Draggable.get(proxy).kill();
  cancelAnimationFrame(animationFrameId);
});

</script>

<template>
  <section class="page" style="overflow: hidden">

    <template v-if="portfolioData">
      <section id="explore-slider">
        <ul class="cards">
          <li class="card" v-for="(portfolioItem, index) in portfolioData">
            <ProjectCover :aria-posinset="index" :aria-setsize="portfolioData.length" :portfolioItem="portfolioItem"
                          :index="index"/>
          </li>
        </ul>
      </section>
    </template>

  </section>
</template>

<style scoped lang="scss">

.page-leave-active {
  transition: all 0.6s;
}

.page-enter-active {
  transition: none;
}

#explore-slider {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  animation: slider-rotation 12s ease-in-out infinite alternate;

  @media screen and (max-width: 768px) {
    margin-bottom: 100px;
    animation: none;
  }
}

.cards {
  position: absolute;
  top: 0;
  left: 0;
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  height: 100%;
  gap: 8px;
}

.card {
  list-style: none;
  padding: 0;
  margin: 0;
  position: absolute;
  left: 0;
}

@keyframes slider-rotation {
  0% {
    transform: rotate3d(0, 0, 1, -3deg);
  }
  100% {
    transform: rotate3d(0, 0, 1, 3deg);
  }
}

</style>
